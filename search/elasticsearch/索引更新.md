### Lucene中的索引段
每个段也是一个倒排索引

### Lucene的提交点
包含所有已知段的文件

### 索引写入
1. 新文档被收集到内存索引缓存
2. 缓存提交到磁盘：
    - 一个新的段--一个追加的倒排索引--被写入磁盘。
    - 一个新的包含新段名字的 提交点 被写入磁盘。
    - 磁盘进行 同步 — 所有在文件系统缓存中等待的写入都刷新到磁盘，以确保它们被写入物理文件。
3. 新的段被开启，让它包含的文档可见以被搜索。
4. 内存缓存被清空，等待接收新的文档。

![索引更新](https://github.com/southCountry/omar-blog/raw/master/images/elasticsearch/index-update.png)

### 索引更新和删除
1. 段是不可改变的
2. 每个提交点会包含一个 .del 文件，文件中会列出这些被删除文档的段信息.
3. 一个被标记删除的文档仍然可以被查询匹配到， 但它会在最终结果被返回前从结果集中移除。
4. 当一个文档被更新时，旧版本文档被标记删除，文档的新版本被索引到一个新的段中。

### refresh
Lucene 允许新段被写入和打开--使其包含的文档在未进行一次完整提交时便对搜索可见。 这种方式比进行一次提交代价要小得多，并且在不影响性能的前提下可以被频繁地执行。

在 Elasticsearch 中，写入和打开一个新段的轻量的过程叫做 refresh 。 默认情况下每个分片会每秒自动刷新一次。

### 持久化变更
1. 一个文档被索引之后，就会被添加到内存缓冲区，并且 追加到了 translog 
2. 刷新（refresh）使缓冲区数据写入索引段中，使其可以被搜索到
3. 每隔一段时间--例如 translog 变得越来越大--索引被刷新（flush）；一个新的 translog 被创建，并且一个全量提交被执行。分片每30分钟被自动刷新（flush），或者在 translog 太大的时候也会刷新。
4. 在文件被 fsync 到磁盘前，被写入的文件在重启之后就会丢失。默认 translog 是每 5 秒被 fsync 刷新到硬盘
![新的文档被添加到内存缓冲区并且被追加到了事务日志](https://github.com/southCountry/omar-blog/raw/master/images/elasticsearch/add-new-doc.png)

### 段合并
![段合并](https://github.com/southCountry/omar-blog/raw/master/images/elasticsearch/segemnt-compact.png)
